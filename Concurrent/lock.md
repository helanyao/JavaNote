# <center>JVM Lock</center>

<br></br>



## 自旋锁
----
**很多共享数据锁定状态持续很短时间。若多个处理器能让两个以的线程并行执行，可让后面请求锁的线程原地自旋（不放弃CPU时间），看持有锁的线程是否很快释放锁。为让线程等待，只须让线程执行一个忙循环（自旋），这就是自旋锁。**

如果锁长时间被占用，则浪费处理器资源。因此自旋等待时间有一定限度。如果自旋超过限定次数仍没成功获得锁，应使用传统方式挂起线程（默认10次）。

<br></br>



## 锁削除
----
**锁削除指JVM即时编译在运行时，对一些代码要求同步，但被检测到不可能存在共享数据竞争的锁进行削除。**

主要判定依据来源于逃逸分析的数据支持。如果判断代码中，在堆上所有数据都不会逃逸出去被其他线程访问，那就把它们当作栈上数据对待，认为它们是线程私有的，同步加锁自然无须进行。

<br></br>



## 锁膨胀
----
如果一系列连续操作都对同一个对象反复加锁和解锁，甚至加锁操作出现在循环中。那即使没有线程竞争，频繁互斥同步操作也会导致不必要的性能损耗。**如果JVM探测到有这样一串操作都对同一个对象加锁，会把加锁同步范围扩展（膨胀）到整个操作序的外部（由多次加锁编程只加锁一次），称作锁膨胀。**

<br></br>



## 轻量级锁
----
轻量级锁不是用来代替重量级锁（传统锁机制，如互斥等），目的是在没有多线程竞争前提下，减少传统重量级锁使用操作系统互斥量产生的性能消耗。

HotSpot JVM对象头（Object Header）分为两部分信息：
1. 存储对象自身运行时数据，如哈希码、GC分代年龄等。这部分数据长度在32位和64位的JVM中分别为32和64Bits，称为Mark Word，是实现轻量级锁和偏向锁的关键。

2. 存储指向方法区对象类型数据指针。如果是数组对象，还会有额外部分存储数组长度。

<br>


### 加锁过程
进入同步块时，如果此同步对象没有被锁定（锁标志位为_01_状态），JVM首先在当前线程栈帧中建立一个名为锁记录（Lock Record）的空间，存储锁对象目前Mark Word拷贝（Displaced Mark Word）。这时线程堆栈与对象头状态：

<p align="center">
  <img src="./Images/lock1.png"/>
</p>

然后，JVM使用CAS操作将对象Mark Word更新为指向Lock Record指针。如果更新成功，线程就拥有该对象锁，且对象Mark Word锁标志位（Mark Word最后两个Bits）变为_00_，表示此对象处于轻量级锁定状态。这时线程堆栈与对象头状态：

<p align="center">
  <img src="./Images/lock2.png"/>
</p>

如果更新操作失败，JVM首先检查对象Mark Word是否指向当前线程栈帧。如果是，说明线程已拥有这个对象锁，可直接进入同步块执行。否则说明这个锁对象已被其他线程抢占。如果有两条以上线程争用同一个锁，那轻量级锁就不再有效，要膨胀为重量级锁。锁标志状态值变为_10_，Mark Word中存储的就是指向重量级锁（互斥量）指针，后面等待锁的线程也进入阻塞状态。

<br>


### 解锁过程
解锁过程是通过CAS。如果对象Mark Word仍指向着线程锁记录，那就用CAS把对象当前Mark Word和线程中复制的Displaced Mark Word替换回来。如果替换成功，整个同步过程完成。如果失败，说明有其他线程尝试获取锁。那就要在释放锁同时，唤醒被挂起的线程。

<br></br>



## 偏向锁
----
**目的是消除数据在无竞争情况下同步原语，提高性能。如果说轻量级锁是在无竞争情况下使用CAS操作去消除同步使用的互斥量，那偏向锁就是在无竞争的情况下把整个同步都消除，连CAS都不做。**

偏向锁偏向第一个获得它的线程（Mark Word中偏向线程ID信息）。如果在接下来执行过程中，该锁没被其他线程获取，则持有偏向锁线程将永远不需再同步。

假设JVM启用偏向锁（`-XX:+UseBiasedLocking`），当锁对象第一次被线程获取时，JVM会把对象头标志位设为_01_，即偏向模式。同时使用CAS把获取这个锁的线程ID记录在对象Mark Word中。如果CAS成功，持有偏向锁线程以后每次进入这个锁相关同步块时，JVM都不再进行任何同步操作。当有另外一个线程尝试获取这个锁时，偏向模式结束。根据锁对象目前是否处于被锁定状态，撤销偏向（Revoke Bias）后恢复到未锁定（标志位为_01_）或轻量级锁定（标志位为_00_）状态，后续同步操作如轻量级锁那样执行。

<p align="center">
  <img src="./Images/lock3.png"/>
</p>

<center><i>偏向锁、轻量级锁的状态转化及对象Mark Word的关系</i></center>